<!--
Click nbfs://nbhost/SystemFileSystem/Templates/Licenses/license-default.txt to change this license
Click nbfs://nbhost/SystemFileSystem/Templates/Other/html.html to edit this template
-->
<html xmlns:th="http://www.thymeleaf.org">
    <head>
        <title>Crear Reserva</title>
         <script>
            document.addEventListener('DOMContentLoaded', function () {
                const dataIniciElem = document.getElementById('dataInici');
                const dataFinElem = document.getElementById('dataFin');
                const checkAvailabilityButton = document.getElementById('checkAvailability');
                const vehicleSelect = document.getElementById('vehicle');
                const clienteSelect = document.getElementById('client');
                const submitButton = document.querySelector('button[type="submit"]'); // Botón Crear Reserva

                // Habilitar el botón de "Comprobar disponibilidad"
                function habilitarBotonComprobar() {
                    checkAvailabilityButton.disabled = !(dataIniciElem.value && dataFinElem.value);
                }

                // Habilitar el selector de cliente cuando las fechas estén seleccionadas
                function habilitarCliente() {
                    clienteSelect.disabled = !(dataIniciElem.value && dataFinElem.value);
                }

                // Habilitar el botón de "Crear Reserva" cuando las fechas y el vehículo estén seleccionados
                function habilitarBotonReserva() {
                    submitButton.disabled = !(dataIniciElem.value && dataFinElem.value && vehicleSelect.value);
                }

                // Comprobar disponibilidad de vehículos
                async function comprobarDisponibilidad() {
                    const dataInici = document.getElementById('dataInici').value;
                    const dataFin = document.getElementById('dataFin').value;

                    if (!dataInici || !dataFin) {
                        alert("Selecciona les dates abans de comprovar la disponibilitat.");
                        return;
                    }

                    try {
                        const response = await fetch(`/reserves/filtrar-vehiculos?dataInici=${dataInici}&dataFin=${dataFin}`);
                        if (!response.ok)
                            throw new Error("Error al consultar la disponibilitat.");
                        const vehicles = await response.json();

                        // Limpiar y actualizar el select de vehículos
                        vehicleSelect.innerHTML = '<option value="" disabled selected>Selecciona un vehicle</option>';
                        vehicles.forEach(vehicle => {
                            const option = document.createElement('option');
                            option.value = vehicle.matricula;
                            option.textContent = `${vehicle.nomVehicle} (${vehicle.combustio})`;
                            option.dataset.preuperhoralloguer = vehicle.preuPerHoraLloguer;
                            option.dataset.fiancastandard = vehicle.fiancaStandard;
                            vehicleSelect.appendChild(option);
                        });

                        // Habilitar el selector de vehículos
                        vehicleSelect.disabled = false;
                    } catch (error) {
                        console.error(error);
                        alert("Hi ha hagut un problema al comprovar la disponibilitat.");
                    }
                }

                // Actualizar los detalles del vehículo y recalcular costos
                function actualizarVehiculo() {
                    const selectedOption = vehicleSelect.selectedOptions[0];

                    if (!selectedOption) {
                        console.error("No hay un vehículo seleccionado.");
                        return;
                    }

                    // Actualizar la tabla con los detalles del vehículo
                    document.getElementById('vehiclePrice').textContent = `${selectedOption.dataset.preuperhoralloguer} €`;
                    document.getElementById('vehicleFianca').textContent = `${selectedOption.dataset.fiancastandard} €`;
                    document.getElementById('vehicleLimitQuilm').textContent = `${selectedOption.dataset.limitquilm} km`;

                    // Mostrar los detalles del vehículo
                    document.getElementById('vehicleDetails').style.display = 'block';

                    // Calcular el costo de la reserva
                    calcularReserva();

                    // Habilitar el botón de "Crear Reserva"
                    habilitarBotonReserva();
                }

                // Calcular el costo de la reserva
                function calcularReserva() {
                    const dataInici = new Date(dataIniciElem.value);
                    const dataFin = new Date(dataFinElem.value);
                    const selectedOption = vehicleSelect.selectedOptions[0];
                    const reputacio = document.getElementById('reputacio').value;

                    if (!dataInici || !dataFin || !selectedOption)
                        return;

                    const horas = Math.max(0, (dataFin - dataInici) / (1000 * 3600));
                    const precioHora = parseFloat(selectedOption.dataset.preuperhoralloguer || 0);
                    const fiancaStandard = parseFloat(selectedOption.dataset.fiancastandard || 0);

                    let fianca = reputacio === 'PREMIUM' ? (fiancaStandard * 0.75).toFixed(2) : fiancaStandard.toFixed(2);
                    let costeHoras = (horas * precioHora).toFixed(2);
                    let costeTotal = (parseFloat(costeHoras) + parseFloat(fianca)).toFixed(2);

                    document.getElementById('totalHoras').textContent = horas;
                    document.getElementById('costHoras').textContent = costeHoras;
                    document.getElementById('fiancaCalculada').textContent = fianca;
                    document.getElementById('costTotal').textContent = costeTotal;
                }

                // Eventos
                dataIniciElem.addEventListener('input', () => {
                    habilitarBotonComprobar();
                    habilitarCliente();
                });
                dataFinElem.addEventListener('input', () => {
                    habilitarBotonComprobar();
                    habilitarCliente();
                });
                checkAvailabilityButton.addEventListener('click', comprobarDisponibilidad);
                vehicleSelect.addEventListener('change', actualizarVehiculo);
                vehicleSelect.addEventListener('change', habilitarBotonReserva); // Habilitar el botón al seleccionar un vehículo
            });
        </script>
    </head>
    <body>
        <h1>Crear Reserva</h1>
        <form th:action="@{/reserves/crear}" th:object="${reserva}" method="post">
            <!-- Fechas -->
            <fieldset>
                <legend>1. Selecciona les dates</legend>
                <input type="datetime-local" id="dataInici" name="dataInici" required />
                <input type="datetime-local" id="dataFin" name="dataFin" required />
                <button type="button" id="checkAvailability" disabled>Comprovar disponibilitat</button>
            </fieldset>

            <!-- Cliente -->
            <fieldset>
                <legend>2. Selecciona un client</legend>
                <select id="client" name="client.dni" required disabled>
                    <option value="" disabled selected>Selecciona un client</option>
                    <option th:each="client : ${clients}" 
                            th:value="${client.dni}" 
                            th:text="${client.nom + ' ' + client.cognoms + ' ' + client.reputacio}" 
                            th:data-reputacio="${client.reputacio}">
                    </option>
                </select>
                <input type="hidden" id="reputacio" value="NORMAL" />
            </fieldset>

            <!-- Vehículos -->
            <fieldset>
                <legend>3. Selecciona un vehicle</legend>
                <select id="vehicle" name="vehicle.matricula" required disabled>
                    <option value="" disabled selected>Selecciona un vehícle</option>
                </select>
            </fieldset>

            <!-- Detalles -->
            <fieldset id="vehicleDetails" style="display: none;">
                <legend>Detalls del vehicle seleccionat</legend>
                <table>
                    <tr><td>Preu per hora:</td><td id="vehiclePrice">--</td></tr>
                    <tr><td>Fiança estándar:</td><td id="vehicleFianca">--</td></tr>
                    <tr><td>Límite de kilometraje:</td><td id="vehicleLimitQuilm">--</td></tr>
                </table>
            </fieldset>

            <!-- Precio total -->
            <fieldset>
                <legend>Detalls del preu</legend>
                <p>Hores: <span id="totalHoras">--</span></p>
                <p>Preu total per hores: €<span id="costHoras">--</span></p>
                <p>Fiança: €<span id="fiancaCalculada">--</span></p>
                <p>Cost total de reserva: €<span id="costTotal">--</span></p>
            </fieldset>

            <button type="submit" disabled>Crear Reserva</button>
        </form>
    </body>
</html>
